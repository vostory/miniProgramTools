<view class="loan-page" data-theme="{{theme}}">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="custom-nav">
    <button class="back-btn" bindtap="goBack">â†</button>
    <!-- <text class="nav-title">æˆ¿è´·è®¡ç®—</text> -->
    <button class="home-btn" bindtap="goHome">ğŸ </button>
  </view>

  <!-- è®¡ç®—ç±»å‹é€‰æ‹© -->
  <view class="calc-type-section">
    <view class="type-buttons">
      <button 
        class="type-btn {{calcType === 'commercial' ? 'active' : ''}}" 
        bindtap="changeCalcType" 
        data-type="commercial"
      >
        å•†ä¸šè´·æ¬¾
      </button>
      <button 
        class="type-btn {{calcType === 'fund' ? 'active' : ''}}" 
        bindtap="changeCalcType" 
        data-type="fund"
      >
        å…¬ç§¯é‡‘è´·æ¬¾
      </button>
      <button 
        class="type-btn {{calcType === 'combined' ? 'active' : ''}}" 
        bindtap="changeCalcType" 
        data-type="combined"
      >
        ç»„åˆè´·æ¬¾
      </button>
    </view>
  </view>

  <!-- è¾“å…¥å‚æ•°åŒºåŸŸ -->
  <view class="input-section">
    <view class="input-card card">
      <!-- è´·æ¬¾æ€»é¢ -->
      <view class="input-group">
        <view class="input-label">
          <text>è´·æ¬¾æ€»é¢</text>
          <text class="input-unit">(ä¸‡å…ƒ)</text>
        </view>
        <view class="dropdown-container">
          <picker 
            class="amount-picker" 
            range="{{amountOptions}}" 
            value="{{amountIndex}}" 
            bindchange="onAmountChange"
          >
            <view class="picker-display">
              <text class="picker-value">{{amountOptions[amountIndex]}} ä¸‡å…ƒ</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        <view class="custom-amount" wx:if="{{showCustomAmount}}">
          <input 
            class="custom-input" 
            type="digit" 
            placeholder="è¾“å…¥è‡ªå®šä¹‰é‡‘é¢" 
            value="{{customAmount}}"
            bindinput="onCustomAmountChange"
          />
        </view>
      </view>

      <!-- è´·æ¬¾å¹´é™ -->
      <view class="input-group">
        <view class="input-label">
          <text>è´·æ¬¾å¹´é™</text>
          <text class="input-unit">(å¹´)</text>
        </view>
        <view class="dropdown-container">
          <picker 
            class="years-picker" 
            range="{{yearsOptions}}" 
            value="{{yearsIndex}}" 
            bindchange="onYearsChange"
          >
            <view class="picker-display">
              <text class="picker-value">{{yearsOptions[yearsIndex]}} å¹´</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- è´·æ¬¾åˆ©ç‡ -->
      <view class="input-group">
        <view class="input-label">
          <text>è´·æ¬¾åˆ©ç‡</text>
          <text class="input-unit">(%)</text>
        </view>
        <view class="dropdown-container">
          <picker 
            class="rate-picker" 
            range="{{rateOptions}}" 
            value="{{rateIndex}}" 
            bindchange="onRateChange"
          >
            <view class="picker-display">
              <text class="picker-value">{{rateOptions[rateIndex]}}%</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- è¿˜æ¬¾æ–¹å¼ -->
      <view class="input-group">
        <view class="input-label">
          <text>è¿˜æ¬¾æ–¹å¼</text>
        </view>
        <view class="repayment-buttons">
          <button 
            class="repayment-btn {{repaymentType === 'equal' ? 'active' : ''}}" 
            bindtap="changeRepaymentType" 
            data-type="equal"
          >
            ç­‰é¢æœ¬æ¯
          </button>
          <button 
            class="repayment-btn {{repaymentType === 'principal' ? 'active' : ''}}" 
            bindtap="changeRepaymentType" 
            data-type="principal"
          >
            ç­‰é¢æœ¬é‡‘
          </button>
        </view>
      </view>

      <!-- è®¡ç®—æŒ‰é’® -->
      <button 
        class="calc-btn" 
        bindtap="calculateLoan"
      >
        å¼€å§‹è®¡ç®—
      </button>
    </view>
  </view>

  <!-- è®¡ç®—ç»“æœ -->
  <view class="result-section" wx:if="{{result}}">
    <view class="result-card card">
      <view class="result-header">
        <text class="result-title">è®¡ç®—ç»“æœ</text>
      </view>

      <!-- å…³é”®æŒ‡æ ‡ -->
      <view class="key-metrics">
        <view class="metric-item">
          <text class="metric-label">è´·æ¬¾æ€»é¢</text>
          <text class="metric-value">{{result.totalLoan}} ä¸‡å…ƒ</text>
        </view>
        <view class="metric-item">
          <text class="metric-label">è´·æ¬¾æœŸé™</text>
          <text class="metric-value">{{result.years}} å¹´ ({{result.months}} æœŸ)</text>
        </view>
        <view class="metric-item">
          <text class="metric-label">è´·æ¬¾åˆ©ç‡</text>
          <text class="metric-value">{{result.rate}}%</text>
        </view>
      </view>

      <!-- è®¡ç®—ç»“æœ -->
      <view class="calc-results">
        <view class="result-item">
          <view class="result-left">
            <text class="result-name">æ¯æœˆæœˆä¾›</text>
            <text class="result-desc">{{repaymentType === 'equal' ? 'æ¯æœˆè¿˜æ¬¾é¢ç›¸åŒ' : 'æ¯æœˆé€’å‡'}}</text>
          </view>
          <view class="result-right">
            <text class="result-value">{{result.monthlyPayment}} å…ƒ</text>
            <text class="result-change" wx:if="{{result.monthlyChange && repaymentType === 'principal'}}">
              æ¯æœˆé€’å‡ {{result.monthlyChange}} å…ƒ
            </text>
          </view>
        </view>

        <view class="result-divider"></view>

        <view class="result-item">
          <view class="result-left">
            <text class="result-name">æ”¯ä»˜åˆ©æ¯</text>
          </view>
          <text class="result-value interest-value">{{result.totalInterest}} å…ƒ</text>
        </view>

        <view class="result-item">
          <view class="result-left">
            <text class="result-name">è¿˜æ¬¾æ€»é¢</text>
          </view>
          <text class="result-value total-value">{{result.totalPayment}} å…ƒ</text>
        </view>
      </view>
    </view>

    <!-- è¯¦ç»†è¿˜æ¬¾è®¡åˆ’ -->
    <view class="plan-section" wx:if="{{repaymentPlan.length > 0}}">
      <view class="plan-header">
        <text class="plan-title">è¿˜æ¬¾è®¡åˆ’è¡¨</text>
        <text class="plan-subtitle">(å‰12æœŸ)</text>
      </view>
      <view class="plan-table">
        <!-- è¡¨å¤´ -->
        <view class="table-header">
          <text class="header-cell period-cell">æœŸæ•°</text>
          <text class="header-cell payment-cell">æœˆä¾›(å…ƒ)</text>
          <text class="header-cell principal-cell">æœ¬é‡‘(å…ƒ)</text>
          <text class="header-cell interest-cell">åˆ©æ¯(å…ƒ)</text>
          <text class="header-cell balance-cell">å‰©ä½™æœ¬é‡‘(å…ƒ)</text>
        </view>
        
        <!-- è¡¨æ ¼å†…å®¹ -->
        <scroll-view class="table-body" scroll-y>
          <view 
            class="table-row" 
            wx:for="{{repaymentPlan}}" 
            wx:key="index"
            data-index="{{index}}"
            bindtap="showDetail"
          >
            <text class="table-cell period-cell">{{item.period}}</text>
            <text class="table-cell payment-cell">{{item.payment}}</text>
            <text class="table-cell principal-cell">{{item.principal}}</text>
            <text class="table-cell interest-cell">{{item.interest}}</text>
            <text class="table-cell balance-cell">{{item.balance}}</text>
          </view>
        </scroll-view>
      </view>
      
      <!-- æŸ¥çœ‹å®Œæ•´è®¡åˆ’æŒ‰é’® -->
      <button class="view-full-btn" bindtap="viewFullPlan">
        æŸ¥çœ‹å®Œæ•´è¿˜æ¬¾è®¡åˆ’
      </button>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="history-section">
    <view class="history-card card">
      <view class="history-header">
        <text class="history-title">è®¡ç®—å†å²</text>
        <button class="clear-btn" bindtap="clearHistory">æ¸…ç©º</button>
      </view>
      <view wx:if="{{history.length > 0}}">
        <scroll-view class="history-list" scroll-y>
          <view 
            class="history-item" 
            wx:for="{{history}}" 
            wx:key="index"
            data-index="{{index}}"
            bindtap="loadHistory"
          >
            <view class="history-content">
              <text class="history-amount">{{item.data.amount}}ä¸‡</text>
              <text class="history-years">{{item.data.years}}å¹´</text>
              <text class="history-rate">{{item.data.rate}}%</text>
              <text class="history-type">{{item.data.type === 'equal' ? 'ç­‰é¢æœ¬æ¯' : 'ç­‰é¢æœ¬é‡‘'}}</text>
            </view>
            <view class="history-result">
              <text class="history-monthly">æœˆä¾›: {{item.data.monthlyPayment}}å…ƒ</text>
              <text class="history-total">æ€»åˆ©æ¯: {{item.data.totalInterest}}å…ƒ</text>
            </view>
            <text class="history-time">{{item.time}}</text>
          </view>
        </scroll-view>
      </view>
      <view wx:else>
        <view class="empty-history">
          <text>æš‚æ— å†å²è®°å½•</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯´æ˜ä¿¡æ¯ -->
  <view class="info-section">
    <view class="info-card card">
      <view class="info-header">
        <text class="info-title">è¿˜æ¬¾æ–¹å¼è¯´æ˜</text>
      </view>
      <view class="info-content">
        <view class="info-item">
          <text class="info-label">ç­‰é¢æœ¬æ¯ï¼š</text>
          <text class="info-text">æ¯æœˆè¿˜æ¬¾é‡‘é¢ç›¸åŒï¼Œå‰æœŸåˆ©æ¯å¤šæœ¬é‡‘å°‘ï¼ŒåæœŸåˆ©æ¯å°‘æœ¬é‡‘å¤š</text>
        </view>
        <view class="info-item">
          <text class="info-label">ç­‰é¢æœ¬é‡‘ï¼š</text>
          <text class="info-text">æ¯æœˆè¿˜æ¬¾æœ¬é‡‘ç›¸åŒï¼Œåˆ©æ¯é€æœˆå‡å°‘ï¼Œæœˆä¾›é€æœˆé€’å‡</text>
        </view>
      </view>
    </view>
  </view>
</view>